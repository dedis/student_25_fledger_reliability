# MergeTB experiments

## Generalities

Those experiments are made for sphere.

An experiment is defined by two things :

- The network topology it uses (see networks)
- An environment for each node in the topology

Each network is defined in `networks/` by:

- The merge model file `model.py`
- The ansible inventory for that topology `hosts`

Each experiment is defined in `expXX-...` by:

- The configuration of the node, i.e. how many instances there are on that node and what they do
- The env, which (for now) only says which topology that experiment runs on
- An explanation (README)

The **configure.sh file** is mostly what matters for each experiment.

### Inner workings

Experiments are ran using ansible.
The ansible playbook and scripts used by the playbook are generic,
the same files / templates are used for all the experiments.
Those files are all in `playbook/` :

- `default.yaml`: the playbook used by all experiments
- `fledger.service`: the template service for an instance of fledger in a node
- `flsignal.service`, `flrealm.service`: the services for the central node
- `scripts/*`: scripts used by the playbook e.g to start and stop instances on nodes

The files in `xdc/` serve two purposes:

- `exp` is used to run an experiment, it's called by run.sh
- the other files are used for scripts I wrote that are not necessary for running the experiments.
  those scripts are not included here.

## Running experiments

### Setup mergeTB

Before doing any of this, you should read the
[merge documentation](https://mergetb.gitlab.io/testbeds/sphere/sphere-docs/docs/experimentation/) and do the
[hello world](https://mergetb.gitlab.io/testbeds/sphere/sphere-docs/docs/experimentation/hello-world/).

Then, create one XDC to be used for all experiments.
Use this SSH configuration (read the documentation before using it):

```bash
# ~/.ssh/config
# Don't forget to replace the values for `YOUR_USER` and `SSH_NAME_FROM_SPHERE`.

Host sphere
 Hostname jump.sphere-testbed.net
 Port 2022
 User YOUR_USER
 IdentityFile ~/.ssh/merge_key
 ServerAliveInterval 30

Host sphere-fledger
 ProxyJump sphere
 IdentityFile ~/.ssh/merge_key
 User YOUR_USER
 Hostname SSH_NAME_FROM_SPHERE
```

On the XDC, install ansible (use the ansible/ansible apt ppa!).

Configure ansible on the XDC with this `~/.ansible.cfg` from the documentation :

```bash
[defaults]
# don't check experiment node keys, if this is not set, you will have to
# explicitly accept the SSH key for each experiment node you run Ansible
# against
host_key_checking = False

# configure up to 5 hosts in parallel
forks = 5

# tmp directory on the local non-shared filesystem. Useful when running ansible
# on multiple separate XDCs
local_tmp = /tmp/ansible/tmp

[ssh_connection]

# connection optimization that increases speed significantly
pipelining = True

# control socket directory on the local non-shared filesystem. Useful when
# running ansible on multiple separate XDCs
control_path_dir = /tmp/ansible/cp
```

Run the command `setup-xdc.sh` at the root of the repo to finish setting up the XDC.

Check the top of the file "run.sh" and verify your username and project name.

### Deploy binaries

This repository only contains the experiments, not the binaries.
To compile those and upload them to the XDC, go to the code repository and run `devbox shell && make deploy` on that repo.

### Run the experiment

Run `./run.sh exp01-onechat2` to run the experiment `exp01-onechat2`.

For some experiments, you can vary the network o which it runs by changing it in the experiment's `env` file.

This will **automatically**:

- Find which network this runs on
- Compile, push, realize, materialize the corresponding model
- Attach the materialization to your XDC
- Upload the experiment files to the XDC with rsync
- SSH into the XDC and run the experiment using ansible
- Download the metrics generated by all the nodes in `latest.metrics``

## Create hosts file for a new experiment

When creating a new experiment, there is a simple (but imperfect) command to generate the hosts file.
It's `mrg nodes generate inventory expX.fledger.abehsser > hosts`

- abehsser is the project name
- fledger the experiment name
- expX the reservation name).

You'll need to modify it to:

1. Group the nodes together in a \[nodes\] group.
2. Put the central server  in a \[central\] group.
3. Remove the router.
